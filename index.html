<!DOCTYPE html>
<html>
<head>
  <title>Raycaster</title>
</head>
<body>
<canvas id="canvas">
<canvas id="screen">
<script type="text/javascript">

window.onload = function() {
  const app = new App
  setInterval(app.gameLoop, 1000/30)
}

class App {
  constructor() {
    this.canvas = new Canvas
    this.screen = new Screen
    this.player = this.canvas.player

    document.addEventListener('keyup', this.handleUp.bind(this))
    document.addEventListener('keydown', this.handleDown.bind(this))

    this.gameLoop = this.gameLoop.bind(this)
  }

  handleDown(event) {
    switch (event.keyCode) {
      case 38:
        this.player.speed = 1
        break
      case 40:
        this.player.speed = -1
        break
      case 37:
        this.player.dir = -1
        break
      case 39:
        this.player.dir = 1
        break
    }
  }

  handleUp(event) {
    if (event.keyCode === 38 || event.keyCode === 40) {
      this.player.speed = 0
    } else if (event.keyCode === 37 || event.keyCode === 39) {
      this.player.dir = 0
    }
  }

  gameLoop() {
    this.canvas.update()
    this.player.render()
    this.player.update()
  }

}

class Canvas {
  constructor() {
    this.canvas = document.getElementById('canvas')
    this.ctx = this.canvas.getContext('2d')

    this.matrix = ([
      [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
      [1, 0, 0, 0, 0, 0, 0, 0, 0, 1],
      [1, 0, 1, 0, 0, 0, 0, 0, 0, 1],
      [1, 0, 0, 0, 0, 0, 0, 0, 0, 1],
      [1, 0, 0, 0, 1, 1, 1, 1, 0, 1],
      [1, 0, 0, 0, 1, 0, 0, 1, 0, 1],
      [1, 0, 0, 0, 1, 0, 0, 1, 0, 1],
      [1, 0, 0, 0, 0, 0, 0, 0, 0, 1],
      [1, 0, 0, 0, 0, 0, 0, 0, 0, 1],
      [1, 1, 1, 1, 1, 1, 1, 1, 1, 1]
    ])

    this.mapDim = this.matrix[0].length

    this.scale = 30
    this.pixelSize = this.mapDim * this.scale

    this.setCanvas()

    this.player = new Player(this)
  }

  setCanvas() {
    this.canvas.width = this.pixelSize
    this.canvas.height = this.pixelSize
  }

  drawMap() {
    for (let y = 0; y < this.mapDim; y++) {
      for (let x = 0; x < this.mapDim; x++) {
        let block = this.matrix[y][x]
        if (block === 1) {
          this.ctx.fillStyle = "black"
          this.ctx.fillRect(x * this.scale, y * this.scale, this.scale, this.scale)
        }
      }
    }
  }

  update() {
    this.ctx.clearRect(0, 0, this.pixelSize, this.pixelSize)
    this.drawMap()
  }

}

class Screen {
  constructor() {
    this.screen = document.getElementById('screen')
    this.stx = this.screen.getContext('2d')

    this.setScreen()
  }

  setScreen() {
    this.screen.width = 600
    this.screen.height = 400
  }
}

class Player {
  constructor(canvas) {
    this.canvas = canvas
    this.scale = canvas.scale
    this.pixelSize = canvas.pixelSize
    this.ctx = canvas.ctx
    this.matrix = canvas.matrix
    this.mapDim = canvas.mapDim

    this.x = 1.5
    this.y = 1.5
    this.dir = 0
    this.rot = 0
    this.size = this.scale / 4

    this.speed = 0
    this.moveSpeed = 0.10
    this.rotSpeed = 6 * Math.PI / 180

    this.stripWidth = 8
    this.fov = 60 * (Math.PI / 180)

    this.numRays = Math.ceil(this.pixelSize / this.stripWidth)
    this.viewDist = (this.pixelSize / 2) / Math.tan(this.fov / 2)
  }

  update() {
    let step = this.speed * this.moveSpeed
    this.rot += this.dir * this.rotSpeed

    let xx = this.x + Math.cos(this.rot) * step
    let yy = this.y + Math.sin(this.rot) * step

    this.checkCollision(xx, yy)
    this.castRays()
  }

  checkCollision(xx, yy){
    if (xx < 0 || xx > this.mapDim || yy < 0 || yy > this.mapDim) {
      return
    }

    if (this.matrix[Math.floor(yy + this.size/this.scale)][Math.floor(xx + this.size/this.scale)] !== 0 || this.matrix[Math.floor(yy)][Math.floor(xx)] !== 0) {
      return
    }

    this.x = xx
    this.y = yy
  }

  castRays() {
    for (let i = 0; i < this.numRays; i++) {
      new Ray(this, i)
    }
  }

  render() {
    this.ctx.fillStyle = "red"
    this.ctx.fillRect(this.x * this.scale, this.y * this.scale, this.size, this.size)
  }

}

class Ray {
  constructor(player, idx) {
    this.player = player
    this.scale = player.scale
    this.size = player.size
    this.ctx = player.ctx
    this.mapDim = player.mapDim
    this.matrix = player.matrix

    this.screenPos = (-this.player.numRays / 2 + idx) * this.player.stripWidth
    this.viewDist = Math.sqrt(Math.pow(this.screenPos, 2) + Math.pow(this.player.viewDist, 2))
    this.angle = Math.asin(this.screenPos / this.viewDist)

    this.xHit = 0
    this.yHit = 0
    this.dist = 0

    this.cast(this.player.rot + this.angle)
  }

  cast(ang) {
    let angMod = ang % (Math.PI * 2)
    const angle = angMod < 0 ? angMod + Math.PI * 2 : angMod

    const right = angle > Math.PI * 2 * 0.75 || angle < Math.PI * 2 * 0.25
    const up = angle > Math.PI

    this.checkHoriz(angle, right)
    this.checkVert(angle, up)

    if (this.dist) {
      this.draw(this.xHit, this.yHit)
    }
  }

  checkHoriz(angle, right) {
    const slope = Math.sin(angle) / Math.cos(angle)
    const dx = right ? 1 : -1
    const dy = dx * slope

    let x = right ? Math.ceil(this.player.x) : Math.floor(this.player.x)
    let y = this.player.y + (x - this.player.x) * slope

    while (x >= 0 && x < this.mapDim && y >= 0 && y < this.mapDim) {

      let mapX = x + (right ? 0 : -1)
      let mapY = Math.floor(y)

      if (this.matrix[mapY][mapX] === 1) {
        this.dist = Math.pow(x - this.player.x, 2) + Math.pow(y - this.player.y, 2)
        this.xHit = x
        this.yHit = y
        break
      }
      x += dx
      y += dy
    }
  }

  checkVert(angle, up) {
    const slope = Math.cos(angle) / Math.sin(angle)
    const dy = up ? -1 : 1
    const dx = dy * slope

    let y = up ? Math.floor(this.player.y) : Math.ceil(this.player.y)
    let x = this.player.x + (y - this.player.y) * slope


    while (x >= 0 && x < this.mapDim && y >= 0 && y < this.mapDim) {

      let mapY = y + (up ? -1 : 0)
      let mapX = Math.floor(x)

      if (this.matrix[mapY][mapX] === 1) {
        let dist = Math.pow(x - this.player.x, 2) + Math.pow(y - this.player.y, 2)
        if (!this.dist || dist < this.dist) {
          this.dist = dist
          this.xHit = x
          this.yHit = y
        }
        break
      }
      x += dx
      y += dy
    }
  }

  draw(x, y) {
    this.ctx.strokeStyle = 'green'
    this.ctx.beginPath()
    this.ctx.moveTo(this.player.x * this.scale + this.size / 2 , this.player.y * this.scale + this.size/2)
    this.ctx.lineTo(x * this.scale, y * this.scale)
    this.ctx.closePath()
    this.ctx.stroke()
  }
}

</script>
</body>
</html>
